<!doctype html>
<html>
<head>
    <title>Server con Socket</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
</head>
<body>
    <style>
        ul {
            list-style: none;
        }
        #chatview,#chatprofile {
            display:none;
        }
        #feedwindow {
            height:300px;
            overflow:auto;
            display:block;
        }
    </style>
    <script type="text/javascript">    
        const socket = io("http://localhost:8080")
        
        socket.on("connect", function() {
            //socket.send('hi');
        })
        socket.on("user_in", () => {
            console.log("saaa")
        })
        socket.on("new_message", data => {
            console.log(data);
            digest(data.body.feed.from,data.body.feed.msg);
        })
        function digest(user,msg) {
            let feed = document.createElement('li');
            feed.innerHTML = `${user}: ${msg}`;
            document.getElementById("chatfeed").appendChild(feed);
        }
        window.onload = function() {
            document.getElementById("buttonGoProfile").addEventListener('click', ()=>{
                document.getElementById("chatview").style.display = 'none';
                document.getElementById("chatprofile").style.display = 'block';
            });
            document.getElementById("buttonChat").addEventListener('click', submitFeed);
            document.getElementById("buttonEnter").addEventListener('click', login);
            document.getElementById("buttonEditProfile").addEventListener('click', editProfile);
            function login(event) {
                event.preventDefault();
                let user = document.forms['login'].user.value;
                fetch('http://localhost:8080/?login='+user)
                .then(
                    function(response) {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem. Status Code: ' +
                        response.status);
                        return;
                    }
        
                    document.getElementById('chatlogin').style.display = "none";
                    document.getElementById('chatview').style.display = "block";
        
                    // Examine the text in the response
                    response.json().then(function(data) {
                        console.log(data);
                    });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error :-S', err);
                });
            }
            function editProfile(event) {
                event.preventDefault();
                let user = document.forms['login'].user.value;
                let firstname = document.forms['profile'].nombre.value;
                let lastname = document.forms['profile'].apellido.value;
                fetch('http://localhost:8080/?profile='+user+'%%'+firstname+'%%'+lastname)
                .then(
                    function(response) {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem. Status Code: ' +
                        response.status);
                        return;
                    }
        
                    document.getElementById('chatprofile').style.display = "none";
                    document.getElementById('chatview').style.display = "block";
        
                    // Examine the text in the response
                    response.json().then(function(data) {
                        console.log(data);
                    });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error :-S', err);
                });
            }
            function submitFeed(event) {
                event.preventDefault();
                let user = document.forms['login'].user.value;
                let msg = document.forms['messageform'].message.value
                socket.emit("message",user,msg, function(data) {
                    console.log(data);
                })
                digest(user,msg)
            }
        }
        </script>
    <header>
        <h1>Chat</h1>
    </header>
    <container id="chatlogin">
        <form action="/login" method="post" name="login" id="login">
            <label for="user">
                Usuario
            </label>
            <input name="user" type="text" maxlength="16"/>
            <label for="password">
                Clave
            </label>
            <input name="password" type="password" />
            <button type="submit" form="login" id="buttonEnter">Entrar</button>
        </form>
    </container>
    <container id="chatprofile">
        <form action="/profile" method="post" name="profile" id="profile">
            <label for="user">Usuario</label>
            <span></span>
            <label for="nombre">Nombre</label>
            <input name="nombre" type="text" maxlength="16"/>
            <label for="apellido">Apellido</label>
            <input name="apellido" type="text" maxlength="16"/>
            <button type="submit" form="profile" id="buttonEditProfile">Editar</button>
        </form>
    </container>
        <container id="chatview">
        <container id="feedwindow">
            <ul id="chatfeed"></ul>
        </container>
        <form action="/chatfeed" method="post" name="messageform" id="messageform">
            <label for="message">
                Mensaje
            </label>
            <textarea name="message" maxlength="256"></textarea>
        </form>
        <button type="submit" form="chatfeed" id="buttonChat">Enviar</button>
        <button type="button" id="buttonGoProfile">Mi perfil</button>
    </container>
</body>
</html>