<!doctype html>
<html>
<head>
    <title>Server con Socket</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
</head>
<body>
    <style>
        ul {
            list-style: none;
        }
        #chatview,#chatprofile,#chatlogin {
            display:none;
        }
        #feedwindow {
            height:300px;
            overflow:auto;
            display:block;
        }
    </style>
    <script type="text/javascript">    
        const jQ = function(id) { return document.getElementById(id) }
        const eL = function(el) { return document.createElement(el) }
        const F = function(name) { return document.forms[name] }

        const socket = io("http://localhost:8080")        
        socket.on("connect", function() {
            //socket.send('hi');
        })
        socket.on("user_in", () => {
            console.log("se conectÃ³ un")
        })
        socket.on("new_message", data => {
            console.log(data);
            digest(data.body.feed.from,data.body.feed.msg);
        })
        function digest(user,msg) {
            let feed = eL('li');
            feed.innerHTML = `${user}: ${msg}`;
            jQ("chatfeed").appendChild(feed);
        }

        const Scenes = {
            LOGIN: 'chatlogin',
            REGISTER: 'chatregister',
            CHATFEED: 'chatview',
            PROFILE: 'chatprofile'
        }

        window.onload = function() {
            
            jQ("buttonGoProfile").addEventListener('click', ()=>{
                jQ("chatview").style.display = 'none';
                jQ("chatprofile").style.display = 'block';
            });

            jQ("buttonRegister").addEventListener('click', register);
            jQ("goLogin").addEventListener('click', goLogin);
            jQ("buttonChat").addEventListener('click', submitFeed);
            jQ("buttonEnter").addEventListener('click', login);
            jQ("buttonEditProfile").addEventListener('click', editProfile);

            function goLogin() {
                jQ("chatlogin").style.display = 'block';
                jQ("chatregister").style.display = 'none';
            }
            function login(event) {
                event.preventDefault();
                let data = { user: F('login').user.value }
                fetch('http://localhost:8080/?login', {
                    method: 'POST', body: JSON.stringify(data),
                    headers:{
                        'Content-Type': 'application/json'
                    }
                })
                .then(
                    function(response) {
                        if (response.status !== 200) {
                            console.log(`NOT OK: ${response.status}`);
                            return;
                        }
            
                        jQ('chatlogin').style.display = "none";
                        jQ('chatview').style.display = "block";
            
                        response.json().then(function(data) {
                            console.log(data);
                        });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error :-S', err);
                });
            }
            function register(event) {
                event.preventDefault();
                let input = F('register');
                let data = { firstname: input.firstname.value,
                    lastname: input.lastname.value,
                    user: input.user.value,
                    email: input.email.value
                }
                fetch('http://localhost:8080/?register', {
                    method: 'POST', body: JSON.stringify(data),
                    headers:{
                        'Content-Type': 'application/json'
                    }
                })
                .then(
                    function(response) {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem. Status Code: ' +
                        response.status);
                        return;
                    }
        
                    jQ('chatregister').style.display = "none";
                    jQ('chatview').style.display = "block";
        
                    // Examine the text in the response
                    response.json().then(function(data) {
                        console.log(data);
                    });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error :-S', err);
                });
            }
            function editProfile(event) {
                event.preventDefault();
                let data = {
                    user: F('login').user.value,
                    firstname: F('profile').nombre.value,
                    lastname: F('profile').apellido.value
                }
                fetch('http://localhost:8080/?profile', {
                    method: 'POST', body: JSON.stringify(data),
                    headers:{
                        'Content-Type': 'application/json'
                    }
                })
                .then(
                    function(response) {
                        if (response.status !== 200) {
                            console.log(`NOT OK: ${response.status}`);
                            return;
                        }
            
                        jQ(Scenes.PROFILE).style.display = "none";
                        jQ(Scenes.CHATFEED).style.display = "block";
            
                        response.json().then(function(data) {
                            console.log(data);
                        });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error :', err);
                });
            }
            function submitFeed(event) {
                event.preventDefault();
                let user = F('login').user.value;
                let msg = F('messageform').message.value
                socket.emit("message",user,msg, function(data) {
                    console.log(data);
                })
                digest(user,msg)
            }
        }
        </script>
    <header>
        <h1>Chat</h1>
    </header>
    <container id="chatlogin">
        <form action="/login" method="post" name="login" id="login">
            <label for="user">
                Usuario
            </label>
            <input name="user" type="text" maxlength="16"/>
            <label for="email">
                Email
            </label>
            <input name="email" type="text" maxlength="16"/>
            <button type="submit" form="login" id="buttonEnter">Entrar</button>
        </form>
    </container>
    <container id="chatregister">
            <form action="/register" method="post" name="register" id="register">
                <label for="firstname">
                    Nombre
                </label>
                <input name="firstname" type="text" maxlength="16"/>
                <label for="lastname">
                    Apellido
                </label>
                <input name="lastname" type="text" maxlength="16"/>
                <label for="user">
                    Usuario
                </label>
                <input name="user" type="text" maxlength="16"/>
                <label for="email">
                    Email
                </label>
                <input name="email" type="text" maxlength="16"/>
                <button type="submit" form="register" id="buttonRegister">Registrar</button>
                <button type="button" form="login" id="goLogin">Login</button>
            </form>
        </container>
        <container id="chatprofile">
        <form action="/profile" method="post" name="profile" id="profile">
            <label for="user">Usuario</label>
            <span></span>
            <label for="nombre">Nombre</label>
            <input name="nombre" type="text" maxlength="16"/>
            <label for="apellido">Apellido</label>
            <input name="apellido" type="text" maxlength="16"/>
            <button type="submit" form="profile" id="buttonEditProfile">Editar</button>
        </form>
    </container>
        <container id="chatview">
        <container id="feedwindow">
            <ul id="chatfeed"></ul>
        </container>
        <form action="/chatfeed" method="post" name="messageform" id="messageform">
            <label for="message">
                Mensaje
            </label>
            <textarea name="message" maxlength="256"></textarea>
        </form>
        <button type="submit" form="chatfeed" id="buttonChat">Enviar</button>
        <button type="button" id="buttonGoProfile">Mi perfil</button>
    </container>
</body>
</html>