<!doctype html>
<html>
<head>
    <title>Server con Socket</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
</head>
<body>
    <style>
        ul {
            list-style: none;
        }
        .view header {
            display:block;
        }
        #container {
            position:absolute;
            width:100%;

        }
        .view form {
            padding:20px;
            padding:10px;
            width: 370px;
        }
        .view label {
            padding:20px;
            display: inline-block;
        }
        .view input {
        }
        .view {
            margin:0 auto;
            position:relative;
            display:flex;
            width: 310px;
            height: 500px;
            border: 1px solid #666;
            border-radius: 30px;
        }
        .view label {
            display: inline-block;            
        }
        #chatview,#chatprofile,#chatlogin {
            display:none
        }
        #feedwindow {
            height:300px;
            overflow:auto;
            display:block;
        }
    </style>
    <script type="text/javascript">
        if (typeof fetch !== 'function') alert("Navegador incompatible");
        const jQ = function(id) { return document.getElementById(id) }
        const qS = function(q) { return document.querySelector(q) }
        const eL = function(el) { return document.createElement(el) }
        const F = function(name) { return document.forms[name] }
        const AppConfig = {
            SOCKET_URL: "http://localhost:8080"
        }
        const Event = {
            CONNECT: 'connect',
            USER_IN: 'user_in',
            NEW_MESSAGE: 'new_message',
            CLICK: 'click'
        }

        const socket = io(AppConfig.SOCKET_URL)        
        socket.on(Event.CONNECT, function() {
            //socket.send('hi');
        })
        socket.on(Event.USER_IN, function() {
            console.log("se conect√≥ un")
        })
        socket.on(Event.NEW_MESSAGE, function(data) {
            console.log(data);
            digest(data.body.feed.from,data.body.feed.msg);
        })
        function digest(user,msg) {
            let feed = eL('li');
            feed.innerHTML = user +": "+ msg;
            jQ("chatfeed").appendChild(feed);
        }

        const Scene = {
            LOGIN: 'chatlogin',
            REGISTER: 'chatregister',
            CHATFEED: 'chatview',
            PROFILE: 'chatprofile'
        }

        window.onload = function() {
            
            jQ("buttonGoProfile").addEventListener(Event.CLICK, function(){
                jQ(Scene.CHATFEED).style.display = 'none';
                jQ(Scene.PROFILE).style.display = 'block';
                qS('#chatprofile .user').innerHTML = F('login').user.value;
            });

            jQ("buttonRegister").addEventListener(Event.CLICK, register);
            jQ("goLogin").addEventListener(Event.CLICK, goLogin);
            jQ("buttonChat").addEventListener(Event.CLICK, submitFeed);
            jQ("buttonEnter").addEventListener(Event.CLICK, login);
            jQ("buttonEditProfile").addEventListener(Event.CLICK, editProfile);

            function goLogin() {
                jQ(Scene.LOGIN).style.display = 'block';
                jQ(Scene.REGISTER).style.display = 'none';
            }
            function login(event) {
                event.preventDefault();
                let data = { user: F('login').user.value }
                fetch('http://localhost:8080/?login', {
                    method: 'POST', body: JSON.stringify(data),
                    headers:{
                        'Content-Type': 'application/json'
                    }
                })
                .then(
                    function(response) {
                        if (response.status !== 200) {
                            console.log("NOT OK: "+response.status);
                            return;
                        }
            
                        jQ(Scene.LOGIN).style.display = "none";
                        jQ(Scene.CHATFEED).style.display = "block";
            
                        response.json().then(function(data) {
                            console.log(data);
                        });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error: ', err);
                });
            }
            function register(event) {
                event.preventDefault();
                let input = F('register');
                let data = { firstname: input.firstname.value,
                    lastname: input.lastname.value,
                    user: input.user.value,
                    email: input.email.value
                }
                fetch('http://localhost:8080/?register', {
                    method: 'POST', body: JSON.stringify(data),
                    headers:{
                        'Content-Type': 'application/json'
                    }
                })
                .then(
                    function(response) {
                        if (response.status !== 200) {
                            console.log('Error: ' +
                            response.status);
                            return;
                        }
            
                        jQ(Scene.REGISTER).style.display = "none";
                        jQ(Scene.CHATFEED).style.display = "block";
            
                        F('login').user.value = data.user;
                        F('login').email.value = data.email;
                        response.json().then(function(data) {
                            console.log(data);
                        });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error:', err);
                });
            }
            function editProfile(event) {
                event.preventDefault();
                let data = {
                    user: F('login').user.value,
                    firstname: F('profile').nombre.value,
                    lastname: F('profile').apellido.value
                }
                fetch('http://localhost:8080/?profile', {
                    method: 'POST', body: JSON.stringify(data),
                    headers:{
                        'Content-Type': 'application/json'
                    }
                })
                .then(
                    function(response) {
                        if (response.status !== 200) {
                            console.log("NOT OK: "+response.status);
                            return;
                        }
            
                        jQ(Scene.PROFILE).style.display = "none";
                        jQ(Scene.CHATFEED).style.display = "block";
            
                        response.json().then(function(data) {
                            console.log(data);
                        });
                    }
                )
                .catch(function(err) {
                    console.log('Fetch Error :', err);
                });
            }
            function submitFeed(event) {
                event.preventDefault();
                let user = F('login').user.value;
                let msg = F('messageform').message.value
                socket.emit("message",user,msg, function(data) {
                    console.log(data);
                })
                digest(user,msg)
            }
        }
        </script>
    <div id="container">
        <container class="view" id="chatlogin">
            <header>
                <h1>Chat</h1>
            </header>
            <form action="/login" method="post" name="login" id="login">
                <label for="user">
                    Usuario
                    <input name="user" type="text" maxlength="16"/>
                </label>
                <label for="email">
                    Email
                    <input name="email" type="text" maxlength="16"/>
                </label>
                <button type="submit" form="login" id="buttonEnter">Entrar</button>
            </form>
        </container>
        <container class="view" id="chatregister">
            <header>
                <h1>Chat</h1>
            </header>
            <form action="/register" method="post" name="register" id="register">
                <label for="firstname">
                    Nombre
                    <input name="firstname" type="text" maxlength="16"/>
                </label>
                <label for="lastname">
                    Apellido
                    <input name="lastname" type="text" maxlength="16"/>
                </label>
                <label for="user">
                    Usuario
                    <input name="user" type="text" maxlength="16"/>
                </label>
                <label for="email">
                    Email
                    <input name="email" type="text" maxlength="16"/>
                </label>
                <label for="actions">
                    <button type="submit" form="register" id="buttonRegister">Registrar</button>
                    <button type="button" form="login" id="goLogin">Login</button>
                </label>
            </form>
        </container>
        <container class="view" id="chatprofile">
            <header>
                <h1>Chat</h1>
            </header>
            <form action="/profile" method="post" name="profile" id="profile">
                <label for="user">Usuario</label>
                <span class="user"></span>
                <label for="nombre">Nombre
                    <input name="nombre" type="text" maxlength="16"/>
                </label>
                <label for="apellido">Apellido
                    <input name="apellido" type="text" maxlength="16"/>
                </label>
                <label for="actions">
                    <button type="submit" form="profile" id="buttonEditProfile">Editar</button>
                </label>
            </form>
        </container>
        <container class="view" id="chatview">
            <container id="feedwindow">
                <ul id="chatfeed"></ul>
            </container>
            <form action="/chatfeed" method="post" name="messageform" id="messageform">
                <label for="message">
                    Mensaje
                </label>
                <textarea name="message" maxlength="256"></textarea>
            </form>
            <label for="actions">
                <button type="submit" form="chatfeed" id="buttonChat">Enviar</button>
                <button type="button" id="buttonGoProfile">Mi perfil</button>
            </label>
        </container>
    </div>
</body>
</html>